import{lpAddQueryArgs,lpFetchAPI}from"../utils";document.addEventListener("submit",(e=>{window.lpCheckout.submit(e)})),document.addEventListener("change",(e=>{window.lpCheckout.paymentSelect(e)})),document.addEventListener("keyup",(e=>{window.lpCheckout.checkEmailGuest(e)})),window.lpCheckout={idFormCheckout:"learn-press-checkout-form",idBtnPlaceOrder:"learn-press-checkout-place-order",classPaymentMethod:"lp-payment-method",classPaymentMethodForm:"payment-method-form",timeOutCheckEmail:null,fetchAPI:(e,t,o)=>{const s={headers:{}};0!==parseInt(lpData.user_id)&&(s.headers["X-WP-Nonce"]=lpData.nonce);const c=new URLSearchParams;Object.keys(t).forEach((e=>{c.append(e,t[e])})),s.method="POST",s.body=c,fetch(e,s).then((e=>e.text())).then((e=>{e=LP.parseJSON(e),o.success(e)})).finally((()=>{o.completed()})).catch((e=>o.error(e)))},submit:e=>{const t=e.target;if(t.id!==window.lpCheckout.idFormCheckout)return;if(t.classList.contains("processing"))return;e.preventDefault(),t.classList.add("processing");const o=t.querySelector('button[type="submit"]');o.disabled=!0,window.lpCheckout.removeMessage();const s=document.getElementById(window.lpCheckout.idBtnPlaceOrder),c=new URL(lpCheckoutSettings.ajaxurl);c.searchParams.set("lp-ajax","checkout");const r=new FormData(t),n=Object.fromEntries(Array.from(r.keys(),(e=>{const t=r.getAll(e);return[e,t.length>1?t:t.pop()]})));s.classList.add("loading");const a={success:e=>{e=LP.parseJSON(e);const{messages:o,result:s}=e;"success"!==s?window.lpCheckout.showErrors(t,"error",o):window.location.href=e.redirect},error:e=>{window.lpCheckout.showErrors(t,"error",e)},completed:()=>{s.classList.remove("loading"),t.classList.remove("processing"),o.disabled=!1}};window.lpCheckout.fetchAPI(c,n,a)},paymentSelect:e=>{const t=e.target.closest(`.${window.lpCheckout.classPaymentMethod}`);if(!t)return;const o=t.closest(".payment-methods");if(!o)return;o.querySelectorAll(`.${window.lpCheckout.classPaymentMethod}`).forEach((e=>{const o=e.querySelector(`.${window.lpCheckout.classPaymentMethodForm}`);o&&(o.style.display=t!==e?"none":"block")}))},checkEmailGuest:e=>{const t=e.target;"guest_email"===t.id&&window.lpCheckout.isEmail(t.value)&&(t.classList.add("loading"),null!==window.lpCheckout.timeOutCheckEmail&&clearTimeout(window.lpCheckout.timeOutCheckEmail),window.lpCheckout.timeOutCheckEmail=setTimeout((()=>{const e={success:e=>{const{message:o,data:s,status:c}=e;if("success"===c){const e=s.content||"",o=document.querySelector(".lp-guest-checkout-output");o&&o.remove(),t.insertAdjacentHTML("afterend",e)}else window.lpCheckout.showErrors(t.closest("form"),c,o)},error:e=>{window.lpCheckout.showErrors(t.closest("form"),"error",e)},completed:()=>{t.classList.remove("loading")}};window.lpCheckout.fetchAPI(window.location.href,{"lp-ajax":"checkout-user-email-exists",email:t.value},e)}),500))},removeMessage:()=>{const e=document.querySelector(".learn-press-message");e&&e.remove()},showErrors:(e,t,o)=>{const s=`<div class="learn-press-message ${t}">${o}</div>`;e.insertAdjacentHTML("afterbegin",s),e.scrollIntoView()},isEmail:e=>new RegExp("^[-!#$%&'*+\\./0-9=?A-Z^_`a-z{|}~]+@[-!#$%&'*+\\/0-9=?A-Z^_`a-z{|}~]+.[-!#$%&'*+\\./0-9=?A-Z^_`a-z{|}~]+$").test(e)};