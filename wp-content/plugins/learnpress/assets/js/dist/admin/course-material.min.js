document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("current-material-post-id").value,t=document.getElementById("material-max-file-size").value,a=document.querySelector(".lp-material--field-upload").getAttribute("accept").split(","),l=document.getElementById("available-to-upload"),n=document.getElementById("btn-lp--add-material"),i=document.getElementById("lp-material--add-material-template"),r=document.getElementById("lp-material--group-container"),o=document.getElementById("lp-material-container"),s=document.getElementById("btn-lp--save-material"),c=(e,t)=>{if(!e)return;const a=document.getElementById("delete-material-row-text").value;e.insertAdjacentHTML("beforeend",`<tr data-id="${t.file_id}" data-sort="${t.orders}" >\n              <td class="sort"><span class="dashicons dashicons-menu"></span> ${t.file_name}</td>\n              <td>${d(t.method)}</td>\n              <td><a href="javascript:void(0)" class="delete-material-row" data-id="${t.file_id}">${a}</a></td>\n            </tr>`)},d=e=>e.charAt(0).toUpperCase()+e.substring(1);function m(t,a=!1,i){if(t.length>0){let o=[],s=new FormData,d=!0;if(t.forEach((function(e,t){const a=e.querySelector(".lp-material--field-title").value,l=e.querySelector(".lp-material--field-method").value,n=e.querySelector(".lp-material--field-external-link"),i=e.querySelector(".lp-material--field-upload");let r,c;switch(a||(d=!1),l){case"upload":i.value?(r=i.files[0].name,c="",s.append("file[]",i.files[0])):d=!1;break;case"external":c=n.value,r="",c||(d=!1)}o.push({label:a,method:l,file:r,link:c})})),d){o=JSON.stringify(o);const d=`${lpGlobalSettings.rest}lp/v1/material/item-materials/${e}`;s.append("data",o),i.classList.add("loading"),fetch(d,{method:"POST",headers:{"X-WP-Nonce":lpGlobalSettings.nonce},body:s}).then((e=>e.text())).then((e=>{a?t[0].remove():r.innerHTML="";const i=JSON.parse(e),{message:o,data:s,status:d}=i;if(alert(o),"success"===d&&s.length>0){const e=document.querySelector(".lp-material--table"),t=e.querySelector("thead"),a=e.querySelector("tbody");t.classList.remove("hidden");for(let e=0;e<s.length;e++){const t=s[e];c(a,t)}l.innerText=parseInt(l.innerText)-s.length,n.setAttribute("can-upload",l.innerText)}})).finally((()=>{i.classList.remove("loading")})).catch((e=>console.log(e)))}else alert("Enter file title, choose file or enter file link!")}}(async(e,t)=>{const a=document.querySelector(".lp-material--table tbody");try{const l=`${lpDataAdmin.lp_rest_url}lp/v1/material/item-materials/${t}?is_admin=1&per_page=-1`;fetch(l,{method:"GET",headers:{"X-WP-Nonce":lpGlobalSettings.nonce,"Content-Type":"application/json"}}).then((e=>e.json())).then((t=>{const{data:l,status:n}=t;if("success"===n){if(l&&l.items&&l.items.length>0){const t=l.items;e.querySelector(".lp-skeleton-animation")&&e.querySelector(".lp-skeleton-animation").remove();for(let e=0;e<t.length;e++)c(a,t[e])}}else console.error(t.message)})).catch((e=>console.log(e)))}catch(e){console.log(e.message)}})(o,e),n.addEventListener("click",(function(e){const t=~~this.getAttribute("can-upload");if(r.querySelectorAll(".lp-material--group").length>=t)return!1;r.insertAdjacentHTML("afterbegin",i.innerHTML)})),o.addEventListener("change",(function(e){const l=e.target;if(l.classList.contains("lp-material--field-method")){const e=l.value,t=document.getElementById("lp-material--upload-field-template").innerHTML,a=document.getElementById("lp-material--external-field-template").innerHTML;switch(e){case"upload":l.parentNode.insertAdjacentHTML("afterend",t),l.closest(".lp-material--group").querySelector(".lp-material--external-wrap").remove();break;case"external":l.parentNode.insertAdjacentHTML("afterend",a),l.closest(".lp-material--group").querySelector(".lp-material--upload-wrap").remove()}}l.classList.contains("lp-material--field-upload")&&l.value&&l.files.length>0&&(a.includes(l.files[0].type)?l.files[0].size>1024*t*1024&&(alert(`This file size is greater than ${t}MB! Please choose another file!`),l.value=""):(alert("This file is not allowed! Please choose another file!"),l.value=""))})),o.addEventListener("click",(function(e){const t=e.target;if(t.classList.contains("lp-material--delete")&&"BUTTON"==t.nodeName)t.closest(".lp-material--group").remove();else if(t.classList.contains("lp-material-save-field")){let e=t.closest(".lp-material--group");e=u(e),m(e,!0,t)}return!1})),s.addEventListener("click",(function(e){const t=r.querySelectorAll(".lp-material--group");t.length>0&&m(t,!1,s)})),document.addEventListener("click",(function(t){const a=t.target;if(a.classList.contains("delete-material-row")&&"A"==a.nodeName){const t=a.getAttribute("data-id"),i=document.getElementById("delete-material-message").value;confirm(i)&&wp.apiFetch({path:`lp/v1/material/${t}`,method:"DELETE",data:{item_id:e}}).then((e=>{200===e.status&&e.delete?(a.closest("tr").remove(),l.innerText=1+~~l.innerText,n.setAttribute("can-upload",~~l.innerText)):alert(e.message)})).catch((e=>{console.log(e)})).finally((()=>{}))}}));const u=(p=document.createDocumentFragment().childNodes,e=>{const t={0:{value:e,enumerable:!0},length:{value:1},item:{value(e){return this[+e||0]},enumerable:!0}};return Object.create(p,t)});var p;$(".lp-material--table tbody").sortable({items:"tr",cursor:"move",axis:"y",handle:"td.sort",scrollSensitivity:40,forcePlaceholderSize:!0,helper:"clone",opacity:.65,update(t,a){$(this).sortable("option","disabled",!0),function(){const t=$(".lp-material--table tbody tr"),a=[];t.each((function(e,t){$(this).attr("data-sort",e+1),a.push({file_id:~~$(this).attr("data-id"),orders:e+1})})),wp.apiFetch({path:`lp/v1/material/item-materials/${e}`,method:"PUT",data:{sort_arr:JSON.stringify(a)}}).then((e=>{200==e.status||alert("Sort table fail.")})).catch((e=>{console.log(e)})).finally((()=>{}))}(),$(this).sortable("option","disabled",!1)}})}));